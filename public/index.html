<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demo</title>

    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div id="root"></div>

    <script>
      // ############################

      const api = {
        get(url) {
          switch (url) {
            case "/lots":
              return new Promise((resolve, reject) => {
                setTimeout(() => {
                  resolve([
                    {
                      id: 1,
                      name: "Apple",
                      description: "Apple description",
                      price: 16,
                    },
                    {
                      id: 2,
                      name: "Orange",
                      description: "Orange description",
                      price: 41,
                    },
                  ]);
                }, 1000);
              });
            default:
              throw new Error("Unknown address");
          }
        },
      };

      const stream = {
        subscribe(channel, listener) {
          const match = /price-(\d+)/.exec(channel);

          if (match) {
            setInterval(() => {
              listener({
                id: parseInt(match[1]),
                price: Math.round(Math.random() * 10 + 30)
              })
            }, 2000)
          }
        },
      };

      // ############################

      let state = {
        time: new Date(),
        lots: null,
      };

      // ############################

      function App({ state }) {
        const node = document.createElement("div");
        node.classList.add("app");

        node.append(Header());
        node.append(Clock({ time: state.time }));
        node.append(Lots({ lots: state.lots }));

        return node;
      }

      function Header() {
        const header = document.createElement("header");
        header.classList.add("header");

        header.append(Logo());

        return header;
      }

      function Logo() {
        const logo = document.createElement("img");

        logo.classList.add("logo");
        logo.src =
          "https://cdn.pixabay.com/photo/2021/05/10/10/46/yellow-wall-6243164__340.jpg";

        return logo;
      }

      function Clock({ time }) {
        const node = document.createElement("div");
        node.classList.add("clock");

        const span = document.createElement("span");
        span.classList.add("value");
        span.innerText = time.toLocaleTimeString();

        node.append(span);

        const icon = document.createElement("span");

        if (time.getHours() >= 7 && time.getHours() <= 21) {
          icon.className = "icon day";
        } else {
          icon.className = "icon night";
        }

        node.append(icon);

        return node;
      }

      function Loading() {
        const node = document.createElement("div");
        node.classList.add("loading");
        node.innerText = "Loading...";
        return node;
      }

      function Lots({ lots }) {
        if (lots === null) {
          return Loading();
        }

        const list = document.createElement("div");
        list.classList.add("lots");

        lots.forEach((lot) => list.append(Lot(lot)));

        return list;
      }

      function Lot({ price, name, description }) {
        const item = document.createElement("article");
        item.classList.add("lot");

        const cost = document.createElement("div");
        cost.classList.add("lot__price");
        cost.innerText = price;

        const title = document.createElement("h2");
        title.classList.add("lot__name");
        title.innerText = name;

        const text = document.createElement("p");
        text.classList.add("lot__description");
        text.innerText = description;

        item.append(cost);
        item.append(title);
        item.append(text);

        return item;
      }

      // ############################

      function renderView(state) {
        render(App({ state }), document.getElementById("root"));
      }

      renderView(state);

      // ############################

      setInterval(() => {
        state = {
          ...state,
          time: new Date(),
        };

        renderView(state);
      }, 1000);

      api.get("/lots").then((lots) => {
        state = {
          ...state,
          lots,
        };

        renderView(state);

        const onPrice = (data) => {
          state = {
            ...state,
            lots: state.lots.map((lot) => {
              if (lot.id === data.id) {
                return {
                  ...lot,
                  price: data.price,
                };
              }
              return lot;
            }),
          };

          renderView(state);
        };

        lots.forEach((lot) => {
          stream.subscribe(`price-${lot.id}`, onPrice);
        });
      });

      // ############################

      function render(newDom, realDomRoot) {
        realDomRoot.innerHTML = "";
        realDomRoot.append(newDom);
      }

      // ############################
    </script>
  </body>
</html>
